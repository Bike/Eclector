\chapter{External protocols}

\section{Packages}

\subsection{Package for ordinary reader features}

The package for ordinary reader features is named
\texttt{eclector.reader}.  To use features of this package, we
recommend the use of explicit package prefixes, simply because this
package shadows and exports names that are also exported from the
\texttt{common-lisp} package.  Importing this package will likely
cause conflicts with the \texttt{common-lisp} package otherwise.

\subsection{Package for readtable features}

The package for readtable-related features is named
\texttt{eclector.readertable}.  To use features of this package, we
recommend the use of explicit package prefixes, simply because this
package shadows and exports names that are also exported from the
\texttt{common-lisp} package.  Importing this package will likely
cause conflicts with the \texttt{common-lisp} package otherwise.

\subsection{Package for CST features}

The package for features related to concrete syntax trees is named
eclector.concrete-syntax-tree.  Although this package does not shadow
any symbol in the \texttt{common-lisp} package, we still recommend the
use of explicit package prefixes to refer to symbols in this package.

\section{Ordinary reader features}

\Defun {read} {\optional (input-stream \texttt{*standard-input*})\\
  (eof-error-p \texttt{t})
  (eof-value \texttt{nil})
  (recursive-p \texttt{nil})}

This function is the main entry point for the ordinary reader.  It is
entirely compatible with the standard \commonlisp{} function with the
same name.

\Defvar {*client*}

This variable is used by several generic functions called by
\texttt{read}.  The default value of the variable is \texttt{nil}.
Client code that wants to override or extend the default behavior of
some generic function of \sysname{} should bind this variable to some
standard object and provide a method on that generic function,
specialized to the class of that standard object.

\Defgeneric {read-common} {client input-stream eof-error-p eof-value}

This generic function is called by \texttt{read}, passing it the value
of the variable \texttt{*client*} and the corresponding parameters.
Client code can add methods on this function, specializing them to the
client class of its choice.  The actions that \texttt{read} need to
take for different values of the parameter \texttt{recursive-p} have
already been taken before \texttt{read} calls this generic function.

\Defgeneric {note-skipped-input} {client input-stream}

This generic function is called whenever the reader skips some input
such as a comment or a form that must be skipped because of a reader
conditional.  It is called with the value of the variable
\texttt{*client*} and the input stream from which the input is being
read.  The default method on this generic function does nothing.
Client code can supply a method that specializes to the client class
of its choice.

\Defgeneric {read-token} {input-stream eof-error-p eof-value}

This generic function is called by \texttt{read-common} when it has
been detected that a token should be read.  This function is
responsible for accumulating the characters of the token and then
calling \texttt{interpret-token} (see below) in order to create and
return a token.

\Defgeneric {interpret-token} {token token-escapes input-stream}

This generic function is called by \texttt{read-token} in order to
create a token from accumulated token characters.  the parameter
\textit{token} is a string containing the characters that make up the
token.  The parameter \textit{token-escapes} is a vector of Boolean
values (i.e. \texttt{nil} or \texttt{t}) with the same length as the
string \textit{token}.  It indicates, for each character in
\textit{token} whether the character was \emph{escaped} or read
normally.  This information is used to convert the characters in
\textit{token} according to the \emph{readtable case} of the current
readtable before a token is constructed.
